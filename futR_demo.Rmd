---
title: "futR"
author: "Kirstin Holsman"
date: "3/20/2019"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 4
    fig_width: 5
    highlight: tango
    keep_tex: yes
    latex_engine: xelatex
  html_document:
    df_print: kable
    fig_caption: yes
    theme: flatly
  header-includes:
  - \usepackage{knputenc}
  - \usepackage{unicode-math}
  - \pagenumbering{gobble}
  word_document:
    fig_caption: yes
    fig_width: 4
    keep_md: yes
---



```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R futR

futR() is a generic Rpackage for fitting recruitment models to stock assessment estimates of spawning stock biomass and recruitment with or without climate covariates. The recruitment model is based on Template Model Builder (`TMB`) and formultations follow Maunder and Desriso (2011) using a generalized three parameter stock-recruitment model with environmental covariates (Deriso 1980; Schnute 1985). This includes Ricker (logistic), Beverton Holt, log-linear, and log-linear with biomass lagged by year 'y-1'. The model can be fit with and with out random effects on spawning stock biomass (SSB) and recruitment (R) (i.e., measurement error on SSB and rec) using the methods of  Porch and Lauretta (2016) and with the optional unbiased estimate of sigma (sensu Ludwid and Walters 1981, Porch and Lauretta 2016). Environmental covariates are optional but can be included as main effects or as interactions.

For more information see Holsman et al. 2020 Climate and trophic controls on groundfish recruitment in Alaska.


## Installing futR()

The package can be installed from github using the devtools package:

```{r devtools, echo=T,eval=F}
install.packages("devtools")
```

The projection package can then be installed to R directly:

```{r install, echo=T,eval=F}
devtools::install_github("kholsman/futR")
```

## Fitting Recruitment:

The base function for fitting recruitment requires a data.frame of recruitment and spawning biomass:


```{r setup, echo=T,eval=F}


 # rm(list=ls())
   
  #___________________________________________
  # 1. Set things up
  #___________________________________________
  
  # e.g., 
  main  <-  getwd()
  setwd(main)
  
  # load data, packages, setup, etc.
  source("R/make.R")
    
  #___________________________________________
  # 2. Compile futR	
  #___________________________________________
  
  compile('src/futR.cpp') # this will generate warnings - they can be ignored if "0" is returned

```

## Options

Now we can fit a set of models with and without covariates. There are various switches for fitting models:

### Recruitment formulations (rectype):  
1. Linear (gamma = 0)
2. Beverton Holt (gamma = -1)
3. Ricker (0 < gamma <1 ) ; gamma is estimated (tMethod):  
  *a. *link = cloglog  
  *b. *link = logit
4. Exponential (gamma=1, b<0)

### Observation error options (sigMethod):  
0. No observation error (tau = 0)
1. estimate sigma, random effects on SSB if tau >0, tau input
2. unbiased sigma estimate, tau input
3. as in 1 but with defined measurement error for rec (indep of random effects on Spawners/SSB)
4. as in 1 but with  defined measurement error for rec and Spawners/SSB)

### Link options (tMethod):  
1. cloglog link (g = 1-exp(-exp(gamma)))
2. logit link (g = exp(gamma)/(1+exp(gamma)))  
    
### Environmental effects (if set to "TRUE"" in estparm):  
* beta = effects on pre-lavarl/ effective number of spawners
* lamba = effects on post-spawning success (e.g., age 0+ survival)  
   

# Fit recruitment  

Let's start with some base models:

```{r fit1, echo=T,eval=F}

    
    # 4.1 First run with no observation error on SSB:
         # makeDat will make the input values, data, and phases for the model:
           datlist  <-  makeDat(
                    tauIN      =  1,
                    sigMethod  =  1, 
                    tMethod    =  1,
                    estparams  =  estparams,
                    typeIN     =  4,
                    rec_years  =  rec$years,
                    Rec        =  rec$Robs,
                    SSB        =  rec$SSB,
                    sdSSB      =  rec$sdSSB,
                    sdRec      =  rec$sdRobs,
                    covars     =  NULL,
                    covars_sd  =  NULL)
          
          # run the basic model
          mm1                 <-  runmod(dlistIN=datlist,version="src/futR",recompile=T,simulate=TRUE)
          df1                 <-  data.frame(estimate=as.vector(mm1$sim), parameter=names( mm1$mle)[row(mm1$sim)])
          densityplot( ~ estimate | parameter, data=df1, layout=c(5,1),ylim=c(0,10))
          
          #now change tau
          datlist$rs_dat$tau  <-  0.000001
          
          # re-run the model with tau 
          mm1_t0              <-  runmod(dlistIN=datlist,version="futR",recompile=F,simulate=TRUE)
          df1_t0              <-  data.frame(estimate=as.vector(mm1_t0$sim), parameter=names( mm1_t0$mle)[row(mm1_t0$sim)])
          densityplot( ~ estimate | parameter, data=df1_t0, layout=c(5,1),ylim=c(0,10))
     

```










